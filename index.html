<!DOCTYPE html>
<html lang="ru" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</title>
    <!-- –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ—Å—Ç–æ–π –∏ –∫—Ä–∞—Å–∏–≤—ã–π CSS —Ñ—Ä–µ–π–º–≤–æ—Ä–∫ Pico.css –¥–ª—è —Å—Ç–∏–ª–µ–π -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
    <style>
        /* –û–±—â–∏–µ —Å—Ç–∏–ª–∏ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏ */
        body {
            font-size: 16px;
        }
        main {
            padding-bottom: 2rem;
        }
        /* –°—Ç–∏–ª–∏ –¥–ª—è —Å—Ç–∞—Ç—É—Å–æ–≤ –≤ —Ç–∞–±–ª–∏—Ü–µ –æ—Ç—á–µ—Ç–∞ */
        .status-late { background-color: #a66a00; }
        .status-absent { background-color: #b82525; }
        .status-leave { background-color: #3e65a3; }
        #report-container { overflow-x: auto; } /* –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –¥–ª—è —à–∏—Ä–æ–∫–∏—Ö —Ç–∞–±–ª–∏—Ü */

        /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π */
        .action-btn { 
            --pico-font-size: 0.85em; 
            --pico-padding: 0.3em 0.6em;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .delete-btn { 
            background-color: var(--pico-color-red-500); 
            border-color: var(--pico-color-red-550);
        }
        .delete-btn:hover { 
            background-color: var(--pico-color-red-600); 
            border-color: var(--pico-color-red-650); 
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ */
        .modal-body { 
            max-height: 80vh; 
            overflow-y: auto; 
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ */
        th[data-sort] {
            cursor: pointer;
            user-select: none;
        }
        th[data-sort]:hover {
            background-color: var(--pico-hocus-background-color);
        }
        th.sort-asc::after {
            content: ' ‚ñ≤';
            font-size: 0.8em;
        }
        th.sort-desc::after {
            content: ' ‚ñº';
            font-size: 0.8em;
        }
    </style>
</head>
<body>
    <!-- –≠—Ç–æ—Ç div —Å–∫—Ä—ã–≤–∞–µ—Ç –∫–æ–Ω—Ç–µ–Ω—Ç –¥–æ —É—Å–ø–µ—à–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
    <div id="main-content" style="visibility: hidden;">
        <main class="container">
            <header>
                <h1>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –±–æ—Ç–∞</h1>
            </header>

            <details open>
                <summary><strong>–°–ø–∏—Å–æ–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</strong></summary>
                
                <input type="search" id="search-input" name="search" placeholder="–ü–æ–∏—Å–∫ –ø–æ –§–ò–û...">
                
                <div id="loading-employees" aria-busy="true">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
                <table id="employees-table" style="display: none;">
                    <thead>
                        <tr>
                            <th data-sort="telegram_id">ID</th>
                            <th data-sort="full_name" class="sort-asc">–§–ò–û</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody id="employees-tbody"></tbody>
                </table>
            </details>
            
            <details open>
                <summary><strong>–°–≤–æ–¥–Ω—ã–π –æ—Ç—á–µ—Ç –∑–∞ –º–µ—Å—è—Ü</strong></summary>
                <form id="report-form">
                    <div class="grid">
                        <select id="month-select" required></select>
                        <select id="year-select" required></select>
                        <button type="submit">–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å</button>
                    </div>
                </form>
                <div id="report-container" style="margin-top: 1rem;">
                    <div id="report-loading" aria-busy="true" style="display: none;">–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–∞...</div>
                    <div id="report-error" style="color: var(--pico-color-red); display: none;"></div>
                    <table id="report-table"></table>
                </div>
            </details>
        </main>
    </div>

    <!-- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –î–õ–Ø –£–ü–†–ê–í–õ–ï–ù–ò–Ø –û–¢–°–£–¢–°–¢–í–ò–Ø–ú–ò -->
    <dialog id="leave-modal">
        <article class="modal-body">
            <header>
                <a href="#close" aria-label="Close" class="close" data-target="leave-modal"></a>
                <strong id="leave-modal-header">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ–º</strong>
            </header>
            <form id="leave-form">
                <input type="hidden" id="leave-employee-id">
                <label for="leave-type">–¢–∏–ø –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è</label>
                <select id="leave-type" required>
                    <option value="–û—Ç–ø—É—Å–∫">–û—Ç–ø—É—Å–∫</option>
                    <option value="–ë–æ–ª—å–Ω–∏—á–Ω—ã–π">–ë–æ–ª—å–Ω–∏—á–Ω—ã–π</option>
                </select>
                <div class="grid">
                    <label for="start-date">
                        –ù–∞—á–∞–ª–æ –ø–µ—Ä–∏–æ–¥–∞
                        <input type="date" id="start-date" required>
                    </label>
                    <label for="end-date">
                        –ö–æ–Ω–µ—Ü –ø–µ—Ä–∏–æ–¥–∞
                        <input type="date" id="end-date" required>
                    </label>
                </div>
                <p id="leave-error" style="color: var(--pico-color-red); display: none;"></p>
                <footer>
                    <div class="grid">
                        <button type="submit" data-action="add-leave">‚úÖ –ù–∞–∑–Ω–∞—á–∏—Ç—å</button>
                        <button type="button" class="secondary" data-action="cancel-leave">üö´ –û—Ç–º–µ–Ω–∏—Ç—å –∑–∞ –ø–µ—Ä–∏–æ–¥</button>
                    </div>
                </footer>
            </form>
        </article>
    </dialog>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        const tg = window.Telegram.WebApp;

        // –ì–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –ø–æ–∏—Å–∫–∞ –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
        let viewState = {
            searchQuery: '',
            sortBy: 'full_name',
            sortOrder: 'asc'
        };
        let debounceTimer;

        // --- –û–ë–©–ê–Ø –õ–û–ì–ò–ö–ê ---
        document.addEventListener('DOMContentLoaded', () => {
            tg.ready();
            validateUser();
        });

        function validateUser() {
            if (!tg.initData) {
                document.body.innerHTML = '<main class="container"><h1>–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω.</h1><p>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–∫—Ä–æ–π—Ç–µ —ç—Ç—É –ø–∞–Ω–µ–ª—å —á–µ—Ä–µ–∑ –≤–∞—à–µ–≥–æ Telegram-–±–æ—Ç–∞.</p></main>';
                return;
            }
            fetch('/api/validate_user', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ initData: tg.initData })
            })
            .then(response => {
                if (!response.ok) throw new Error('–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –Ω–µ –ø—Ä–æ–π–¥–µ–Ω–∞!');
                return response.json();
            })
            .then(() => {
                document.getElementById('main-content').style.visibility = 'visible';
                initializePage();
            })
            .catch(error => {
                console.error('Validation Error:', error);
                document.body.innerHTML = `<main class="container"><h1>–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏</h1><p>${error.message}</p></main>`;
            });
        }
        
        function initializePage() {
            loadEmployees();
            setupDateSelector();
            
            // --- –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø –í–°–ï–• –û–ë–†–ê–ë–û–¢–ß–ò–ö–û–í ---
            document.getElementById('search-input').addEventListener('input', handleSearchInput);
            document.querySelector('#employees-table thead').addEventListener('click', handleSortClick);
            document.getElementById('employees-tbody').addEventListener('click', handleEmployeeActionClick);
            document.getElementById('report-form').addEventListener('submit', handleReportFormSubmit);
            document.getElementById('leave-form').addEventListener('submit', handleLeaveFormSubmit);
            document.querySelector("#leave-form button[data-action='cancel-leave']").addEventListener('click', (e) => e.target.closest('form').requestSubmit(e.target));
            document.addEventListener('click', (e) => {
                if(e.target.matches("#leave-modal .close")) {
                    e.preventDefault();
                    document.getElementById(e.target.dataset.target).close();
                }
            });
        }

        // --- –ü–û–ò–°–ö –ò –°–û–†–¢–ò–†–û–í–ö–ê ---
        function handleSearchInput(event) {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                viewState.searchQuery = event.target.value;
                loadEmployees();
            }, 350);
        }

        function handleSortClick(event) {
            const header = event.target.closest('th');
            if (header && header.dataset.sort) {
                const newSortBy = header.dataset.sort;
                if (viewState.sortBy === newSortBy) {
                    viewState.sortOrder = viewState.sortOrder === 'asc' ? 'desc' : 'asc';
                } else {
                    viewState.sortBy = newSortBy;
                    viewState.sortOrder = 'asc';
                }
                loadEmployees();
            }
        }

        function updateSortIndicators() {
            document.querySelectorAll('#employees-table th[data-sort]').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
            });
            const activeHeader = document.querySelector(`#employees-table th[data-sort="${viewState.sortBy}"]`);
            if (activeHeader) {
                activeHeader.classList.add(viewState.sortOrder === 'asc' ? 'sort-asc' : 'sort-desc');
            }
        }

        // --- –°–ü–ò–°–û–ö –°–û–¢–†–£–î–ù–ò–ö–û–í ---
        function loadEmployees() {
            const loadingDiv = document.getElementById('loading-employees');
            const table = document.getElementById('employees-table');
            const tbody = document.getElementById('employees-tbody');
            loadingDiv.style.display = 'block';
            table.style.display = 'none';

            const params = new URLSearchParams({
                sort_by: viewState.sortBy,
                sort_order: viewState.sortOrder
            });
            if (viewState.searchQuery) {
                params.append('q', viewState.searchQuery);
            }
            const apiUrl = `/api/employees?${params.toString()}`;

            fetch(apiUrl)
                .then(response => response.json())
                .then(data => {
                    loadingDiv.style.display = 'none';
                    table.style.display = 'table';
                    tbody.innerHTML = '';
                    data.forEach(employee => {
                        const row = document.createElement('tr');
                        row.dataset.employeeId = employee.id;
                        row.innerHTML = `
                            <td>${employee.id}</td>
                            <td>${employee.full_name}</td>
                            <td>
                                <button class="action-btn" data-action="manage-leave" data-id="${employee.id}" data-name="${employee.full_name}">–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ</button>
                                <button class="action-btn delete-btn" data-action="deactivate" data-id="${employee.id}">–£–¥–∞–ª–∏—Ç—å</button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                    updateSortIndicators();
                })
                .catch(error => {
                    loadingDiv.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤!';
                });
        }
        
        function handleEmployeeActionClick(event) {
            const targetButton = event.target.closest('button');
            if (!targetButton) return;

            const action = targetButton.dataset.action;
            const employeeId = targetButton.dataset.id;
            const employeeName = targetButton.closest('tr').cells[1].textContent;

            if (action === 'deactivate') {
                if (confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ ${employeeName}?`)) {
                    deactivateEmployee(employeeId, targetButton);
                }
            } else if (action === 'manage-leave') {
                const modal = document.getElementById('leave-modal');
                document.getElementById('leave-modal-header').textContent = `–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ: ${employeeName}`;
                document.getElementById('leave-employee-id').value = employeeId;
                modal.showModal();
            }
        }
        
        function deactivateEmployee(id, button) {
            button.setAttribute('aria-busy', 'true');
            button.disabled = true;
            fetch('/api/employees/deactivate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id: parseInt(id) })
            })
            .then(response => {
                if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
                return response.json();
            })
            .then(() => loadEmployees())
            .catch(error => {
                alert(`–ù–µ —É–¥–∞–ª–æ—Å—å –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å: ${error.message}`);
                button.removeAttribute('aria-busy');
                button.disabled = false;
            });
        }

        // --- –£–ü–†–ê–í–õ–ï–ù–ò–ï –û–¢–°–£–¢–°–¢–í–ò–Ø–ú–ò ---
        function handleLeaveFormSubmit(event) {
            event.preventDefault();
            const actionButton = event.submitter;
            const action = actionButton.dataset.action;
            const apiUrl = (action === 'add-leave') ? '/api/leaves/add' : '/api/leaves/cancel';
            const errorDiv = document.getElementById('leave-error');

            const requestBody = {
                employee_id: parseInt(document.getElementById('leave-employee-id').value),
                leave_type: document.getElementById('leave-type').value,
                start_date: document.getElementById('start-date').value,
                end_date: document.getElementById('end-date').value
            };

            if (!requestBody.start_date || !requestBody.end_date) {
                errorDiv.textContent = '–û—à–∏–±–∫–∞: –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –Ω–∞—á–∞–ª—å–Ω—É—é –∏ –∫–æ–Ω–µ—á–Ω—É—é –¥–∞—Ç—É.';
                errorDiv.style.display = 'block';
                return;
            }

            actionButton.setAttribute('aria-busy', 'true');
            actionButton.disabled = true;
            errorDiv.style.display = 'none';

            fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody)
            })
            .then(response => {
                if (!response.ok) return response.json().then(err => { throw new Error(err.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞') });
                return response.json();
            })
            .then(result => {
                alert(`–£—Å–ø–µ—à–Ω–æ: ${result.message}`);
                document.getElementById('leave-modal').close();
                document.getElementById('leave-form').reset();
            })
            .catch(error => {
                errorDiv.textContent = `–û—à–∏–±–∫–∞: ${error.message}`;
                errorDiv.style.display = 'block';
            })
            .finally(() => {
                actionButton.removeAttribute('aria-busy');
                actionButton.disabled = false;
            });
        }
        
        // --- –û–¢–ß–ï–¢–´ ---
        function setupDateSelector() {
            const monthSelect = document.getElementById('month-select');
            const yearSelect = document.getElementById('year-select');
            const months = ["–Ø–Ω–≤–∞—Ä—å", "–§–µ–≤—Ä–∞–ª—å", "–ú–∞—Ä—Ç", "–ê–ø—Ä–µ–ª—å", "–ú–∞–π", "–ò—é–Ω—å", "–ò—é–ª—å", "–ê–≤–≥—É—Å—Ç", "–°–µ–Ω—Ç—è–±—Ä—å", "–û–∫—Ç—è–±—Ä—å", "–ù–æ—è–±—Ä—å", "–î–µ–∫–∞–±—Ä—å"];
            const currentYear = new Date().getFullYear();
            const currentMonth = new Date().getMonth();

            months.forEach((monthName, index) => {
                const option = new Option(monthName, index + 1);
                if (index === currentMonth) option.selected = true;
                monthSelect.add(option);
            });

            for (let i = currentYear; i >= currentYear - 2; i--) {
                yearSelect.add(new Option(i, i));
            }
        }

        function handleReportFormSubmit(event) {
            event.preventDefault();
            const year = document.getElementById('year-select').value;
            const month = document.getElementById('month-select').value;
            
            const loadingDiv = document.getElementById('report-loading');
            const errorDiv = document.getElementById('report-error');
            const table = document.getElementById('report-table');

            loadingDiv.style.display = 'block';
            errorDiv.style.display = 'none';
            table.innerHTML = '';

            fetch(`/api/reports/monthly/${year}/${month}`)
                .then(response => {
                    if (!response.ok) return response.json().then(err => { throw new Error(err.detail) });
                    return response.json();
                })
                .then(result => {
                    loadingDiv.style.display = 'none';
                    renderReportTable(result.data);
                })
                .catch(error => {
                    loadingDiv.style.display = 'none';
                    errorDiv.textContent = `–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –æ—Ç—á–µ—Ç: ${error.message}`;
                    errorDiv.style.display = 'block';
                });
        }

        function renderReportTable(reportData) {
            const table = document.getElementById('report-table');
            const thead = document.createElement('thead');
            const tbody = document.createElement('tbody');
            
            const headerRow = document.createElement('tr');
            reportData[0].forEach(headerText => {
                const th = document.createElement('th');
                th.textContent = headerText;
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);

            reportData.slice(1).forEach(rowData => {
                const row = document.createElement('tr');
                rowData.forEach((cellData, index) => {
                    const cell = document.createElement('td');
                    cell.textContent = cellData;
                    if (index > 0) {
                        const status = cellData.toLowerCase();
                        if (status.includes('–æ–ø–æ–∑–¥–∞–ª')) cell.className = 'status-late';
                        else if (status.includes('–ø—Ä–æ–≥—É–ª') || status.includes('–ø—Ä–æ–ø—É—Å—Ç–∏–ª')) cell.className = 'status-absent';
                        else if (status.includes('–æ—Ç–ø—É—Å–∫') || status.includes('–±–æ–ª—å–Ω–∏—á–Ω—ã–π') || status.includes('–æ—Ç–ø—Ä–æ—Å–∏–ª—Å—è')) cell.className = 'status-leave';
                    }
                    row.appendChild(cell);
                });
                tbody.appendChild(row);
            });

            table.appendChild(thead);
            table.appendChild(tbody);
        }
    </script>
</body>
</html>
