<!DOCTYPE html>
<html lang="ru" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
    <style>
        /* –û–±—â–∏–µ —Å—Ç–∏–ª–∏ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏ */
        body {
            font-size: 16px;
        }
        main {
            padding-bottom: 2rem;
        }
        #report-container { overflow-x: auto; }
        
        /* –ó–µ–ª–µ–Ω—ã–π –¥–ª—è "–í–æ–≤—Ä–µ–º—è" */
        .status-ontime { background-color: #2a9d8f}
        /* –û—Ä–∞–Ω–∂–µ–≤—ã–π –¥–ª—è "–û–ø–æ–∑–¥–∞–ª" */
        .status-late { background-color: #e76f51}
        /* –ö—Ä–∞—Å–Ω—ã–π –¥–ª—è –ø—Ä–æ–ø—É—Å–∫–æ–≤ –∏ –ø—Ä–æ–±–ª–µ–º */
        .status-absent { background-color: #e63946}
        /* –°–∏–Ω–∏–π –¥–ª—è –æ—Ç–ø—É—Å–∫–æ–≤/–±–æ–ª—å–Ω–∏—á–Ω—ã—Ö */
        .status-leave { background-color: #5252b9}
        /* –§–∏–æ–ª–µ—Ç–æ–≤—ã–π –¥–ª—è –ø—Ä–∞–∑–¥–Ω–∏–∫–æ–≤ */
        .status-holiday { background-color: #8349a9}
        /* –°–µ—Ä—ã–π –¥–ª—è –≤—ã—Ö–æ–¥–Ω—ã—Ö */
        .status-dayoff { background-color: #38514e }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π */
        .action-btn { 
            --pico-font-size: 0.85em; 
            --pico-padding: 0.3em 0.6em;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .delete-btn { 
            background-color: var(--pico-color-red-500); 
            border-color: var(--pico-color-red-550);
        }
        .delete-btn:hover { 
            background-color: var(--pico-color-red-600); 
            border-color: var(--pico-color-red-650); 
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ */
        .modal-body { 
            max-height: 80vh; 
            overflow-y: auto; 
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ */
        th[data-sort] {
            cursor: pointer;
            user-select: none;
        }
        th[data-sort]:hover {
            background-color: var(--pico-hocus-background-color);
        }
        th.sort-asc::after {
            content: ' ‚ñ≤';
            font-size: 0.8em;
        }
        th.sort-desc::after {
            content: ' ‚ñº';
            font-size: 0.8em;
        }
        /* --- –ù–û–í–´–ï –°–¢–ò–õ–ò –î–õ–Ø –ó–ê–ö–†–ï–ü–õ–ï–ù–ù–û–ì–û –°–¢–û–õ–ë–¶–ê --- */
        #report-table th:first-child,
        #report-table td:first-child {
            position: -webkit-sticky; /* –î–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å Safari */
            position: sticky;
            left: 0;
            /* –í–∞–∂–Ω–æ: —Ñ–æ–Ω, —á—Ç–æ–±—ã –∫–æ–Ω—Ç–µ–Ω—Ç –ø–æ–¥ –Ω–∏–º –Ω–µ –ø—Ä–æ—Å–≤–µ—á–∏–≤–∞–ª –ø—Ä–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–µ */
            background-color: var(--pico-card-background-color);
        }

        /* –î–µ–ª–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Ç–∞–±–ª–∏—Ü—ã –≤—ã—à–µ, —á—Ç–æ–±—ã –æ–Ω –±—ã–ª –Ω–∞–¥ —è—á–µ–π–∫–∞–º–∏ */
        #report-table thead th {
            z-index: 3;
        }
        
        #report-table td:first-child {
            z-index: 1;
        }
        /* --- –ö–û–ù–ï–¶ –ù–û–í–´–• –°–¢–ò–õ–ï–ô --- */
        #holidays-list li { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
        #holidays-list span { flex-grow: 1; }
        #holidays-list button { margin-left: 1rem; }
    </style>
</head>
<body>
    <div id="main-content" style="visibility: hidden;">
        <main class="container">
            <header>
                <h1>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –±–æ—Ç–∞</h1>
            </header>

            <details open>
                <summary><strong>–°–ø–∏—Å–æ–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</strong></summary>
                
                <div class="grid">
                    <input type="search" id="search-input" name="search" placeholder="–ü–æ–∏—Å–∫ –ø–æ –§–ò–û...">
                    <button id="add-employee-btn" data-target="add-employee-modal">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</button>
                </div>

                <div id="loading-employees" aria-busy="true">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
                <table id="employees-table" style="display: none;">
                    <thead>
                        <tr>
                            <th data-sort="telegram_id">ID</th>
                            <th data-sort="full_name" class="sort-asc">–§–ò–û</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody id="employees-tbody"></tbody>
                </table>
            </details>

            <details>
                <summary><strong>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–∑–¥–Ω–∏–∫–∞–º–∏</strong></summary>
                <div class="grid">
                    <label for="holiday-year-select">
                        –ì–æ–¥
                        <select id="holiday-year-select"></select>
                    </label>
                </div>
                <div id="holidays-loading" aria-busy="true" style="display: none;">–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∞–∑–¥–Ω–∏–∫–æ–≤...</div>
                <ul id="holidays-list"></ul>
                <form id="add-holiday-form" style="margin-top: 1rem;">
                    <fieldset class="grid">
                        <input type="date" id="new-holiday-date" required>
                        <input type="text" id="new-holiday-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–∞–∑–¥–Ω–∏–∫–∞" required>
                        <button type="submit">–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∞–∑–¥–Ω–∏–∫</button>
                    </fieldset>
                </form>
            </details>

            <details open>
                <summary><strong>–°–≤–æ–¥–Ω—ã–π –æ—Ç—á–µ—Ç –∑–∞ –º–µ—Å—è—Ü</strong></summary>
                <form id="report-form">
                    <div class="grid">
                        <select id="month-select" required></select>
                        <select id="year-select" required></select>
                        <button type="submit">–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å</button>
                    </div>
                </form>
                <div id="report-container" style="margin-top: 1rem;">
                    <div id="report-loading" aria-busy="true" style="display: none;">–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–∞...</div>
                    <div id="report-error" style="color: var(--pico-color-red); display: none;"></div>
                    <table id="report-table"></table>
                </div>
            </details>
        </main>
    </div>
    
    <dialog id="log-modal">
        <article>
            <header>
                <a href="#close" aria-label="Close" class="close" data-target="log-modal"></a>
                <strong id="log-modal-header">–ò—Å—Ç–æ—Ä–∏—è —Å–æ–±—ã—Ç–∏–π</strong>
            </header>
            
            <form id="log-form">
                <input type="hidden" id="log-employee-id">
                <div class="grid">
                    <input type="date" id="log-start-date" required>
                    <input type="date" id="log-end-date" required>
                    <button type="submit">–ü–æ–∫–∞–∑–∞—Ç—å</button>
                </div>
            </form>

            <div id="log-loading" aria-busy="true" style="display: none;">–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏...</div>
            <div id="log-error" style="color: var(--pico-color-red); display: none;"></div>
            <div style="max-height: 50vh; overflow-y: auto; margin-top: 1rem;">
                <table id="log-table">
                    <thead><tr><th>–í—Ä–µ–º—è</th><th>–¢–∏–ø</th><th>–°—Ç–∞—Ç—É—Å</th><th>–î–µ—Ç–∞–ª–∏</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </article>
    </dialog>

    <dialog id="add-employee-modal">
        <article class="modal-body">
            <header>
                <a href="#close" aria-label="Close" class="close" data-target="add-employee-modal"></a>
                <strong>–ù–æ–≤—ã–π —Å–æ—Ç—Ä—É–¥–Ω–∏–∫</strong>
            </header>
            <form id="add-employee-form">
                <label for="new-employee-id">Telegram ID</label>
                <input type="number" id="new-employee-id" required>

                <label for="new-employee-name">–§–ò–û</label>
                <input type="text" id="new-employee-name" required>

                <label for="new-effective-date">–ì—Ä–∞—Ñ–∏–∫ –¥–µ–π—Å—Ç–≤—É–µ—Ç —Å –¥–∞—Ç—ã</label>
                <input type="date" id="new-effective-date" required>
                
                <p><strong>–ì—Ä–∞—Ñ–∏–∫ —Ä–∞–±–æ—Ç—ã</strong> (–≤ —Ñ–æ—Ä–º–∞—Ç–µ `09:00-18:00`, –¥–ª—è –≤—ã—Ö–æ–¥–Ω–æ–≥–æ –≤–≤–µ–¥–∏—Ç–µ `0`)</p>
                <div class="grid">
                    <label>–ü–ù <input type="text" class="schedule-input" data-day="0" placeholder="09:00-18:00"></label>
                    <label>–í–¢ <input type="text" class="schedule-input" data-day="1" placeholder="09:00-18:00"></label>
                </div>
                <div class="grid">
                    <label>–°–† <input type="text" class="schedule-input" data-day="2" placeholder="09:00-18:00"></label>
                    <label>–ß–¢ <input type="text" class="schedule-input" data-day="3" placeholder="09:00-18:00"></label>
                </div>
                <div class="grid">
                    <label>–ü–¢ <input type="text" class="schedule-input" data-day="4" placeholder="09:00-18:00"></label>
                    <label>–°–ë <input type="text" class="schedule-input" data-day="5" placeholder="0"></label>
                </div>
                <div class="grid">
                    <label>–í–° <input type="text" class="schedule-input" data-day="6" placeholder="0"></label>
                </div>
                
                <p id="add-employee-error" style="color: var(--pico-color-red); display: none;"></p>
                <footer>
                    <button type="submit">‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </footer>
            </form>
        </article>
    </dialog>
    
    <dialog id="edit-employee-modal">
        <article class="modal-body">
            <header>
                <a href="#close" aria-label="Close" class="close" data-target="edit-employee-modal"></a>
                <strong id="edit-modal-header">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</strong>
            </header>
            <div id="edit-form-loading" aria-busy="true" style="display: none;">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞...</div>
            <form id="edit-employee-form" style="display: none;">
                <input type="hidden" id="edit-employee-original-id">
                
                <label for="edit-employee-id">Telegram ID (–Ω–µ–ª—å–∑—è –∏–∑–º–µ–Ω–∏—Ç—å)</label>
                <input type="number" id="edit-employee-id" readonly>

                <label for="edit-employee-name">–§–ò–û</label>
                <input type="text" id="edit-employee-name" required>

                <label for="edit-effective-date">–ü—Ä–∏–º–µ–Ω–∏—Ç—å –Ω–æ–≤—ã–π –≥—Ä–∞—Ñ–∏–∫ —Å –¥–∞—Ç—ã</label>
                <input type="date" id="edit-effective-date" required>
                
                <p><strong>–ì—Ä–∞—Ñ–∏–∫ —Ä–∞–±–æ—Ç—ã</strong> (–≤ —Ñ–æ—Ä–º–∞—Ç–µ `09:00-18:00`, –¥–ª—è –≤—ã—Ö–æ–¥–Ω–æ–≥–æ –≤–≤–µ–¥–∏—Ç–µ `0`)</p>
                <div class="grid">
                    <label>–ü–ù <input type="text" class="edit-schedule-input" data-day="0"></label>
                    <label>–í–¢ <input type="text" class="edit-schedule-input" data-day="1"></label>
                </div>
                <div class="grid">
                    <label>–°–† <input type="text" class="edit-schedule-input" data-day="2"></label>
                    <label>–ß–¢ <input type="text" class="edit-schedule-input" data-day="3"></label>
                </div>
                <div class="grid">
                    <label>–ü–¢ <input type="text" class="edit-schedule-input" data-day="4"></label>
                    <label>–°–ë <input type="text" class="edit-schedule-input" data-day="5"></label>
                </div>
                <div class="grid">
                    <label>–í–° <input type="text" class="edit-schedule-input" data-day="6"></label>
                </div>
                
                <p id="edit-employee-error" style="color: var(--pico-color-red); display: none;"></p>
                <footer>
                    <button type="submit">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
                </footer>
            </form>
        </article>
    </dialog>

    <dialog id="leave-modal">
        <article class="modal-body">
            <header>
                <a href="#close" aria-label="Close" class="close" data-target="leave-modal"></a>
                <strong id="leave-modal-header">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ–º</strong>
            </header>
            <form id="leave-form">
                <input type="hidden" id="leave-employee-id">
                <label for="leave-type">–¢–∏–ø –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è</label>
                <select id="leave-type" required>
                    <option value="–û—Ç–ø—É—Å–∫">–û—Ç–ø—É—Å–∫</option>
                    <option value="–ë–æ–ª—å–Ω–∏—á–Ω—ã–π">–ë–æ–ª—å–Ω–∏—á–Ω—ã–π</option>
                </select>
                <div class="grid">
                    <label for="start-date">
                        –ù–∞—á–∞–ª–æ –ø–µ—Ä–∏–æ–¥–∞
                        <input type="date" id="start-date" required>
                    </label>
                    <label for="end-date">
                        –ö–æ–Ω–µ—Ü –ø–µ—Ä–∏–æ–¥–∞
                        <input type="date" id="end-date" required>
                    </label>
                </div>
                <p id="leave-error" style="color: var(--pico-color-red); display: none;"></p>
                <footer>
                    <div class="grid">
                        <button type="submit" data-action="add-leave">‚úÖ –ù–∞–∑–Ω–∞—á–∏—Ç—å</button>
                        <button type="button" class="secondary" data-action="cancel-leave">üö´ –û—Ç–º–µ–Ω–∏—Ç—å –∑–∞ –ø–µ—Ä–∏–æ–¥</button>
                    </div>
                </footer>
            </form>
        </article>
    </dialog>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        const tg = window.Telegram.WebApp;

        // –ì–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –ø–æ–∏—Å–∫–∞ –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
        let viewState = {
            searchQuery: '',
            sortBy: 'full_name',
            sortOrder: 'asc'
        };
        let debounceTimer;

        // --- –û–ë–©–ê–Ø –õ–û–ì–ò–ö–ê ---
        document.addEventListener('DOMContentLoaded', () => {
            tg.ready();
            validateUser();
        });

        function validateUser() {
            if (!tg.initData) {
                document.body.innerHTML = '<main class="container"><h1>–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω.</h1><p>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–∫—Ä–æ–π—Ç–µ —ç—Ç—É –ø–∞–Ω–µ–ª—å —á–µ—Ä–µ–∑ –≤–∞—à–µ–≥–æ Telegram-–±–æ—Ç–∞.</p></main>';
                return;
            }
            fetch('/api/validate_user', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ initData: tg.initData })
            })
            .then(response => {
                if (!response.ok) throw new Error('–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –Ω–µ –ø—Ä–æ–π–¥–µ–Ω–∞!');
                return response.json();
            })
            .then(() => {
                document.getElementById('main-content').style.visibility = 'visible';
                initializePage();
            })
            .catch(error => {
                console.error('Validation Error:', error);
                document.body.innerHTML = `<main class="container"><h1>–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏</h1><p>${error.message}</p></main>`;
            });
        }
        
        function initializePage() {
            loadEmployees();
            setupDateSelector();
            setupHolidayManager();

            // --- –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø –í–°–ï–• –û–ë–†–ê–ë–û–¢–ß–ò–ö–û–í ---
            document.getElementById('add-employee-btn').addEventListener('click', () => document.getElementById('add-employee-modal').showModal());
            document.getElementById('add-employee-form').addEventListener('submit', handleAddEmployeeSubmit);
            document.getElementById('edit-employee-form').addEventListener('submit', handleEditEmployeeSubmit);
            document.getElementById('search-input').addEventListener('input', handleSearchInput);
            document.querySelector('#employees-table thead').addEventListener('click', handleSortClick);
            document.getElementById('employees-tbody').addEventListener('click', handleEmployeeActionClick);
            document.getElementById('report-form').addEventListener('submit', handleReportFormSubmit);
            document.getElementById('leave-form').addEventListener('submit', handleLeaveFormSubmit);
            document.querySelector("#leave-form button[data-action='cancel-leave']").addEventListener('click', (e) => e.target.closest('form').requestSubmit(e.target));
            

            document.getElementById('holiday-year-select').addEventListener('change', loadHolidays);
            document.getElementById('add-holiday-form').addEventListener('submit', handleAddHoliday);
            document.getElementById('holidays-list').addEventListener('click', handleDeleteHoliday);
            document.getElementById('log-form').addEventListener('submit', handleLogFormSubmit); // <-- –ù–û–í–´–ô
            // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
            document.addEventListener('click', (e) => {
                if(e.target.matches(".close")) {
                    e.preventDefault();
                    document.getElementById(e.target.dataset.target).close();
                }
            });
        }
        // --- –ù–û–í–´–ô –ë–õ–û–ö –§–£–ù–ö–¶–ò–ô –î–õ–Ø –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ü–†–ê–ó–î–ù–ò–ö–ê–ú–ò ---
        function setupHolidayManager() {
            const yearSelect = document.getElementById('holiday-year-select');
            const currentYear = new Date().getFullYear();
            for (let i = currentYear + 1; i >= currentYear - 2; i--) {
                const option = new Option(i, i);
                if (i === currentYear) option.selected = true;
                yearSelect.add(option);
            }
            loadHolidays();
        }

        function loadHolidays() {
            const year = document.getElementById('holiday-year-select').value;
            const list = document.getElementById('holidays-list');
            const loading = document.getElementById('holidays-loading');
            
            list.innerHTML = '';
            loading.style.display = 'block';

            fetch(`/api/holidays/${year}`)
                .then(response => {
                    if (!response.ok) return [];
                    return response.json();
                })
                .then(data => {
                    data.forEach(holiday => {
                        const li = document.createElement('li');
                        const date = new Date(holiday.holiday_date).toLocaleDateString('ru-RU');
                        li.innerHTML = `
                            <span><strong>${date}</strong> - ${holiday.holiday_name}</span>
                            <button class="secondary outline" data-date="${holiday.holiday_date}">–£–¥–∞–ª–∏—Ç—å</button>
                        `;
                        list.appendChild(li);
                    });
                })
                .catch(error => console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∞–∑–¥–Ω–∏–∫–æ–≤:", error))
                .finally(() => loading.style.display = 'none');
        }

        function handleAddHoliday(event) {
            event.preventDefault();
            const date = document.getElementById('new-holiday-date').value;
            const name = document.getElementById('new-holiday-name').value;
            if (!date || !name) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞—Ç—É –∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–∞–∑–¥–Ω–∏–∫–∞.');
                return;
            }
            
            fetch('/api/holidays/add', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ holiday_date: date, holiday_name: name })
            })
            .then(response => {
                if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –ø—Ä–∞–∑–¥–Ω–∏–∫–∞');
                document.getElementById('add-holiday-form').reset();
                loadHolidays();
            })
            .catch(error => alert(error.message));
        }

        function handleDeleteHoliday(event) {
            if (event.target.tagName !== 'BUTTON') return;
            const date = event.target.dataset.date;
            if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –ø—Ä–∞–∑–¥–Ω–∏–∫ ${date}?`)) return;

            fetch('/api/holidays/delete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ holiday_date: date })
            })
            .then(response => {
                if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø—Ä–∞–∑–¥–Ω–∏–∫–∞');
                loadHolidays();
            })
            .catch(error => alert(error.message));
        }
        // --- –ö–û–ù–ï–¶ –ù–û–í–û–ì–û –ë–õ–û–ö–ê ---


        // --- –î–û–ë–ê–í–õ–ï–ù–ò–ï –°–û–¢–†–£–î–ù–ò–ö–ê ---
        function handleAddEmployeeSubmit(event) {
            event.preventDefault();
            const form = event.target;
            const submitButton = form.querySelector('button[type="submit"]');
            const errorDiv = document.getElementById('add-employee-error');
            errorDiv.style.display = 'none';

            const schedule = {};
            let isScheduleValid = true;
            const timePattern = /^([01]\d|2[0-3]):([0-5]\d)-([01]\d|2[0-3]):([0-5]\d)$/;
            
            form.querySelectorAll('.schedule-input').forEach(input => {
                const day = input.dataset.day;
                const value = input.value.trim();
                input.setAttribute('aria-invalid', 'false');
                if (value === '0' || value === '') {
                    schedule[day] = {};
                } else if (timePattern.test(value)) {
                    const [start, end] = value.split('-');
                    schedule[day] = { start, end };
                } else {
                    isScheduleValid = false;
                    input.setAttribute('aria-invalid', 'true');
                }
            });

            if (!isScheduleValid) {
                errorDiv.textContent = '–û—à–∏–±–∫–∞: –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –≤—Ä–µ–º–µ–Ω–∏ –≤ –≥—Ä–∞—Ñ–∏–∫–µ. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ß–ß:–ú–ú-–ß–ß:–ú–ú –∏–ª–∏ 0.';
                errorDiv.style.display = 'block';
                return;
            }

            const requestBody = {
                telegram_id: parseInt(document.getElementById('new-employee-id').value),
                full_name: document.getElementById('new-employee-name').value,
                effective_date: document.getElementById('new-effective-date').value,
                schedule: schedule
            };

            if (!requestBody.telegram_id || !requestBody.full_name || !requestBody.effective_date) {
                errorDiv.textContent = '–û—à–∏–±–∫–∞: –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è: ID, –§–ò–û –∏ –¥–∞—Ç—É.';
                errorDiv.style.display = 'block';
                return;
            }

            submitButton.setAttribute('aria-busy', 'true');
            submitButton.disabled = true;

            fetch('/api/employees/add', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody)
            })
            .then(response => {
                if (!response.ok) return response.json().then(err => { throw new Error(err.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞') });
                return response.json();
            })
            .then(result => {
                alert(`–£—Å–ø–µ—à–Ω–æ: ${result.message}`);
                document.getElementById('add-employee-modal').close();
                form.reset();
                loadEmployees(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
            })
            .catch(error => {
                errorDiv.textContent = `–û—à–∏–±–∫–∞: ${error.message}`;
                errorDiv.style.display = 'block';
            })
            .finally(() => {
                submitButton.removeAttribute('aria-busy');
                submitButton.disabled = false;
            });
        }

        // --- –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï –°–û–¢–†–£–î–ù–ò–ö–ê ---
        function handleEditEmployeeSubmit(event) {
            event.preventDefault();
            const form = event.target;
            const submitButton = form.querySelector('button[type="submit"]');
            const errorDiv = document.getElementById('edit-employee-error');
            errorDiv.style.display = 'none';

            const schedule = {};
            let isScheduleValid = true;
            const timePattern = /^([01]\d|2[0-3]):([0-5]\d)-([01]\d|2[0-3]):([0-5]\d)$/;
            
            form.querySelectorAll('.edit-schedule-input').forEach(input => {
                const day = input.dataset.day;
                const value = input.value.trim();
                input.setAttribute('aria-invalid', 'false');
                if (value === '0' || value === '') {
                    schedule[day] = {};
                } else if (timePattern.test(value)) {
                    const [start, end] = value.split('-');
                    schedule[day] = { start, end };
                } else {
                    isScheduleValid = false;
                    input.setAttribute('aria-invalid', 'true');
                }
            });

            if (!isScheduleValid) {
                errorDiv.textContent = '–û—à–∏–±–∫–∞: –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –≤—Ä–µ–º–µ–Ω–∏ –≤ –≥—Ä–∞—Ñ–∏–∫–µ. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ß–ß:–ú–ú-–ß–ß:–ú–ú –∏–ª–∏ 0.';
                errorDiv.style.display = 'block';
                return;
            }

            const requestBody = {
                telegram_id: parseInt(document.getElementById('edit-employee-id').value),
                full_name: document.getElementById('edit-employee-name').value,
                effective_date: document.getElementById('edit-effective-date').value,
                schedule: schedule
            };
            
            submitButton.setAttribute('aria-busy', 'true');
            submitButton.disabled = true;

            fetch('/api/employees/update', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody)
            })
            .then(response => {
                if (!response.ok) return response.json().then(err => { throw new Error(err.detail || '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞') });
                return response.json();
            })
            .then(result => {
                alert(`–£—Å–ø–µ—à–Ω–æ: ${result.message}`);
                document.getElementById('edit-employee-modal').close();
                loadEmployees(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
            })
            .catch(error => {
                errorDiv.textContent = `–û—à–∏–±–∫–∞: ${error.message}`;
                errorDiv.style.display = 'block';
            })
            .finally(() => {
                submitButton.removeAttribute('aria-busy');
                submitButton.disabled = false;
            });
        }

        // --- –ü–û–ò–°–ö –ò –°–û–†–¢–ò–†–û–í–ö–ê ---
        function handleSearchInput(event) {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                viewState.searchQuery = event.target.value;
                loadEmployees();
            }, 350);
        }

        function handleSortClick(event) {
            const header = event.target.closest('th');
            if (header && header.dataset.sort) {
                const newSortBy = header.dataset.sort;
                if (viewState.sortBy === newSortBy) {
                    viewState.sortOrder = viewState.sortOrder === 'asc' ? 'desc' : 'asc';
                } else {
                    viewState.sortBy = newSortBy;
                    viewState.sortOrder = 'asc';
                }
                loadEmployees();
            }
        }

        function updateSortIndicators() {
            document.querySelectorAll('#employees-table th[data-sort]').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
            });
            const activeHeader = document.querySelector(`#employees-table th[data-sort="${viewState.sortBy}"]`);
            if (activeHeader) {
                activeHeader.classList.add(viewState.sortOrder === 'asc' ? 'sort-asc' : 'sort-desc');
            }
        }

        // --- –°–ü–ò–°–û–ö –°–û–¢–†–£–î–ù–ò–ö–û–í ---
        function loadEmployees() {
            const loadingDiv = document.getElementById('loading-employees');
            const table = document.getElementById('employees-table');
            const tbody = document.getElementById('employees-tbody');
            loadingDiv.style.display = 'block';
            table.style.display = 'none';

            const params = new URLSearchParams({
                sort_by: viewState.sortBy,
                sort_order: viewState.sortOrder
            });
            if (viewState.searchQuery) {
                params.append('q', viewState.searchQuery);
            }
            const apiUrl = `/api/employees?${params.toString()}`;

            fetch(apiUrl)
                .then(response => response.json())
                .then(data => {
                    loadingDiv.style.display = 'none';
                    table.style.display = 'table';
                    tbody.innerHTML = '';
                    
                    data.forEach(employee => {
                        const row = document.createElement('tr');
                        row.dataset.employeeId = employee.id;
                        row.innerHTML = `
                            <td>${employee.id}</td>
                            <td>${employee.full_name}</td>
                            <td>
                                <button class="action-btn" data-action="view_log" data-id="${employee.id}" data-name="${employee.full_name}">–ò—Å—Ç–æ—Ä–∏—è</button>
                                <button class="action-btn" data-action="edit" data-id="${employee.id}">–ò–∑–º–µ–Ω–∏—Ç—å</button>
                                <button class="action-btn" data-action="manage-leave" data-id="${employee.id}" data-name="${employee.full_name}">–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ</button>
                                <button class="action-btn delete-btn" data-action="deactivate" data-id="${employee.id}">–£–¥–∞–ª–∏—Ç—å</button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                    updateSortIndicators();
                })
                .catch(error => {
                    loadingDiv.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤!';
                });
        }
        
        function handleEmployeeActionClick(event) {
            const targetButton = event.target.closest('button');
            if (!targetButton) return;

            const action = targetButton.dataset.action;
            const employeeId = targetButton.dataset.id;
            const employeeName = targetButton.closest('tr').cells[1].textContent;

            if (action === 'deactivate') {
                if (confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ ${employeeName}?`)) {
                    deactivateEmployee(employeeId, targetButton);
                }
            } else if (action === 'manage-leave') {
                const modal = document.getElementById('leave-modal');
                document.getElementById('leave-modal-header').textContent = `–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ: ${employeeName}`;
                document.getElementById('leave-employee-id').value = employeeId;
                modal.showModal();
            } else if (action === 'edit') {
                openEditModalFor(employeeId);
            }
            else if (action === 'view_log') { // <-- –ù–û–í–´–ô –ë–õ–û–ö
                openLogModalFor(employeeId, employeeName);
        }
        }
        // --- –ù–û–í–´–ï –§–£–ù–ö–¶–ò–ò –î–õ–Ø –õ–û–ì–ê ---
        function openLogModalFor(employeeId, employeeName) {
            const modal = document.getElementById('log-modal');
            document.getElementById('log-modal-header').textContent = `–ò—Å—Ç–æ—Ä–∏—è: ${employeeName}`;
            document.getElementById('log-employee-id').value = employeeId;
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∞—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –Ω–∞ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü
            const today = new Date();
            const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            document.getElementById('log-start-date').valueAsDate = startOfMonth;
            document.getElementById('log-end-date').valueAsDate = today;

            modal.showModal();
            // –°—Ä–∞–∑—É –∑–∞–≥—Ä—É–∂–∞–µ–º –ª–æ–≥ –∑–∞ –ø–µ—Ä–∏–æ–¥ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            document.getElementById('log-form').requestSubmit();
        }

        function handleLogFormSubmit(event) {
            event.preventDefault();
            const employeeId = document.getElementById('log-employee-id').value;
            const startDate = document.getElementById('log-start-date').value;
            const endDate = document.getElementById('log-end-date').value;

            const loading = document.getElementById('log-loading');
            const errorDiv = document.getElementById('log-error');
            const tableBody = document.querySelector('#log-table tbody');

            loading.style.display = 'block';
            errorDiv.style.display = 'none';
            tableBody.innerHTML = '';

            fetch(`/api/employees/${employeeId}/log?start_date=${startDate}&end_date=${endDate}`)
            .then(response => {
                if (!response.ok) return response.json().then(err => { throw new Error(err.detail) });
                return response.json();
            })
            .then(data => {
                if (data.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="4">–ù–µ—Ç —Å–æ–±—ã—Ç–∏–π –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥.</td></tr>';
                    return;
                }
                data.forEach(log => {
                    const row = document.createElement('tr');
                    let details = '';
                    if (log.distance_meters !== null) details += `–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ: ${log.distance_meters}–º. `;
                    if (log.face_similarity !== null) details += `–°—Ö–æ–∂–µ—Å—Ç—å: ${log.face_similarity.toFixed(1)}%`;
                    
                    row.innerHTML = `
                        <td>${log.timestamp}</td>
                        <td>${log.check_in_type}</td>
                        <td>${log.status}</td>
                        <td>${details || '-'}</td>
                    `;
                    tableBody.appendChild(row);
                });
            })
            .catch(error => {
                errorDiv.textContent = `–û—à–∏–±–∫–∞: ${error.message}`;
                errorDiv.style.display = 'block';
            })
            .finally(() => {
                loading.style.display = 'none';
            });
        }
        function openEditModalFor(employeeId) {
            const modal = document.getElementById('edit-employee-modal');
            const form = document.getElementById('edit-employee-form');
            const loading = document.getElementById('edit-form-loading');
            const errorDiv = document.getElementById('edit-employee-error');
            
            form.style.display = 'none';
            loading.style.display = 'block';
            errorDiv.style.display = 'none';
            modal.showModal();

            fetch(`/api/employees/${employeeId}`)
                .then(response => {
                    if (!response.ok) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞');
                    return response.json();
                })
                .then(data => {
                    document.getElementById('edit-employee-id').value = data.telegram_id;
                    document.getElementById('edit-employee-name').value = data.full_name;
                    document.getElementById('edit-effective-date').value = new Date().toISOString().split('T')[0];

                    form.querySelectorAll('.edit-schedule-input').forEach(input => {
                        const day = input.dataset.day;
                        input.value = data.schedule[day] || '0';
                    });

                    loading.style.display = 'none';
                    form.style.display = 'block';
                })
                .catch(err => {
                    loading.style.display = 'none';
                    errorDiv.textContent = err.message;
                    errorDiv.style.display = 'block';
                });
        }
        
        function deactivateEmployee(id, button) {
            button.setAttribute('aria-busy', 'true');
            button.disabled = true;
            fetch('/api/employees/deactivate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id: parseInt(id) })
            })
            .then(response => {
                if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
                return response.json();
            })
            .then(() => loadEmployees())
            .catch(error => {
                alert(`–ù–µ —É–¥–∞–ª–æ—Å—å –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å: ${error.message}`);
                button.removeAttribute('aria-busy');
                button.disabled = false;
            });
        }

        // --- –£–ü–†–ê–í–õ–ï–ù–ò–ï –û–¢–°–£–¢–°–¢–í–ò–Ø–ú–ò ---
        function handleLeaveFormSubmit(event) {
            event.preventDefault();
            const actionButton = event.submitter;
            const action = actionButton.dataset.action;
            const apiUrl = (action === 'add-leave') ? '/api/leaves/add' : '/api/leaves/cancel';
            const errorDiv = document.getElementById('leave-error');

            const requestBody = {
                employee_id: parseInt(document.getElementById('leave-employee-id').value),
                leave_type: document.getElementById('leave-type').value,
                start_date: document.getElementById('start-date').value,
                end_date: document.getElementById('end-date').value
            };

            if (!requestBody.start_date || !requestBody.end_date) {
                errorDiv.textContent = '–û—à–∏–±–∫–∞: –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –Ω–∞—á–∞–ª—å–Ω—É—é –∏ –∫–æ–Ω–µ—á–Ω—É—é –¥–∞—Ç—É.';
                errorDiv.style.display = 'block';
                return;
            }

            actionButton.setAttribute('aria-busy', 'true');
            actionButton.disabled = true;
            errorDiv.style.display = 'none';

            fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody)
            })
            .then(response => {
                if (!response.ok) return response.json().then(err => { throw new Error(err.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞') });
                return response.json();
            })
            .then(result => {
                alert(`–£—Å–ø–µ—à–Ω–æ: ${result.message}`);
                document.getElementById('leave-modal').close();
                document.getElementById('leave-form').reset();
            })
            .catch(error => {
                errorDiv.textContent = `–û—à–∏–±–∫–∞: ${error.message}`;
                errorDiv.style.display = 'block';
            })
            .finally(() => {
                actionButton.removeAttribute('aria-busy');
                actionButton.disabled = false;
            });
        }
        
        // --- –û–¢–ß–ï–¢–´ ---
        function setupDateSelector() {
            const monthSelect = document.getElementById('month-select');
            const yearSelect = document.getElementById('year-select');
            const months = ["–Ø–Ω–≤–∞—Ä—å", "–§–µ–≤—Ä–∞–ª—å", "–ú–∞—Ä—Ç", "–ê–ø—Ä–µ–ª—å", "–ú–∞–π", "–ò—é–Ω—å", "–ò—é–ª—å", "–ê–≤–≥—É—Å—Ç", "–°–µ–Ω—Ç—è–±—Ä—å", "–û–∫—Ç—è–±—Ä—å", "–ù–æ—è–±—Ä—å", "–î–µ–∫–∞–±—Ä—å"];
            const currentYear = new Date().getFullYear();
            const currentMonth = new Date().getMonth();

            months.forEach((monthName, index) => {
                const option = new Option(monthName, index + 1);
                if (index === currentMonth) option.selected = true;
                monthSelect.add(option);
            });

            for (let i = currentYear; i >= currentYear - 2; i--) {
                yearSelect.add(new Option(i, i));
            }
        }

        function handleReportFormSubmit(event) {
            event.preventDefault();
            const year = document.getElementById('year-select').value;
            const month = document.getElementById('month-select').value;
            
            const loadingDiv = document.getElementById('report-loading');
            const errorDiv = document.getElementById('report-error');
            const table = document.getElementById('report-table');

            loadingDiv.style.display = 'block';
            errorDiv.style.display = 'none';
            table.innerHTML = '';

            fetch(`/api/reports/monthly/${year}/${month}`)
                .then(response => {
                    if (!response.ok) return response.json().then(err => { throw new Error(err.detail) });
                    return response.json();
                })
                .then(result => {
                    loadingDiv.style.display = 'none';
                    renderReportTable(result.data);
                })
                .catch(error => {
                    loadingDiv.style.display = 'none';
                    errorDiv.textContent = `–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –æ—Ç—á–µ—Ç: ${error.message}`;
                    errorDiv.style.display = 'block';
                });
        }

        function renderReportTable(reportData) {
            const table = document.getElementById('report-table');
            const thead = document.createElement('thead');
            const tbody = document.createElement('tbody');
            
            const headerRow = document.createElement('tr');
            reportData[0].forEach(headerText => {
                const th = document.createElement('th');
                th.textContent = headerText;
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);

            reportData.slice(1).forEach(rowData => {
                const row = document.createElement('tr');
                rowData.forEach((cellData, index) => {
                    const cell = document.createElement('td');
                    cell.textContent = cellData;
                    if (index > 0) { // –ü—Ä–∏–º–µ–Ω—è–µ–º –∫–ª–∞—Å—Å—ã —Ç–æ–ª—å–∫–æ –∫ —è—á–µ–π–∫–∞–º —Å –¥–∞—Ç–∞–º–∏
                        const status = cellData.toLowerCase();
                        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –¥–ª—è —Ü–≤–µ—Ç–æ–≤: –ø—Ä–æ–±–ª–µ–º—ã > –æ–ø–æ–∑–¥–∞–Ω–∏—è > –æ—Ç–≥—É–ª—ã > —É—Å–ø–µ—Ö > —Å–ø–µ—Ü. —Å—Ç–∞—Ç—É—Å—ã
                        if (status.includes('–ø—Ä–æ–≥—É–ª') || status.includes('–ø—Ä–æ–ø—É—Å—Ç–∏–ª') || status.includes('–Ω–µ –∑–∞–≤–µ—Ä—à–∏–ª')) {
                            cell.className = 'status-absent';
                        } else if (status.includes('–æ–ø–æ–∑–¥–∞–ª')) {
                            cell.className = 'status-late';
                        } else if (status.includes('–æ—Ç–ø—É—Å–∫') || status.includes('–±–æ–ª—å–Ω–∏—á–Ω—ã–π') || status.includes('–æ—Ç–ø—Ä–æ—Å–∏–ª—Å—è')) {
                            cell.className = 'status-leave';
                        } else if (status.includes('–≤–æ–≤—Ä–µ–º—è')) {
                            cell.className = 'status-ontime';
                        } else if (status.includes('–ø—Ä–∞–∑–¥–Ω–∏–∫')) {
                            cell.className = 'status-holiday';
                        } else if (status.includes('–≤—ã—Ö–æ–¥–Ω–æ–π')) {
                            cell.className = 'status-dayoff';
                        }
                    }
                    row.appendChild(cell);
                });
                tbody.appendChild(row);
            });

            table.appendChild(thead);
            table.appendChild(tbody);
        }
    </script>
</body>
</html>