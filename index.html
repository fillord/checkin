<!DOCTYPE html>
<html lang="ru" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Админ-панель</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
    <style>
        .status-late { background-color: #a66a00; }
        .status-absent { background-color: #b82525; }
        .status-leave { background-color: #3e65a3; }
        #report-container { overflow-x: auto; }
        .delete-btn { 
            --pico-font-size: 0.8em; 
            --pico-padding: 0.2em 0.5em;
            background-color: var(--pico-color-red-500);
            border-color: var(--pico-color-red-550);
        }
        .delete-btn:hover {
            background-color: var(--pico-color-red-600);
            border-color: var(--pico-color-red-650);
        }
    </style>
</head>
<body>
    <div id="main-content" style="visibility: hidden;">
        <main class="container">
            <header>
                <h1>Админ-панель бота</h1>
            </header>

            <details open>
                <summary><strong>Список сотрудников</strong></summary>
                <div id="loading-employees" aria-busy="true">Загрузка данных...</div>
                <table id="employees-table" style="display: none;">
                    <thead><tr><th>ID</th><th>ФИО</th><th>Действия</th></tr></thead>
                    <tbody id="employees-tbody"></tbody>
                </table>
            </details>
            
            <details open> 
                <summary><strong>Сводный отчет за месяц</strong></summary>
                <form id="report-form">
                    <div class="grid">
                        <select id="month-select" required></select>
                        <select id="year-select" required></select>
                        <button type="submit">Сформировать</button>
                    </div>
                </form>
                
                <div id="report-container" style="margin-top: 1rem;">
                    <div id="report-loading" aria-busy="true" style="display: none;">Формирование отчета...</div>
                    <div id="report-error" style="color: var(--pico-color-red); display: none;"></div>
                    <table id="report-table"></table>
                </div>
            </details>
            
        </main>
    </div>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        const tg = window.Telegram.WebApp;

        document.addEventListener('DOMContentLoaded', () => {
            tg.ready(); // Сообщаем Telegram, что приложение готово
            
            // Сразу после загрузки страницы проверяем авторизацию
            validateUser();
        });

        function validateUser() {
            // Проверяем, есть ли initData (т.е. открыто ли приложение через Telegram)
            if (!tg.initData) {
                document.body.innerHTML = '<main class="container"><h1>Доступ запрещен.</h1><p>Пожалуйста, откройте эту панель через вашего Telegram-бота.</p></main>';
                return;
            }

            fetch('/api/validate_user', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ initData: tg.initData })
            })
            .then(response => {
                if (!response.ok) throw new Error('Авторизация не пройдена!');
                return response.json();
            })
            .then(result => {
                // Если авторизация успешна, показываем основной контент и загружаем данные
                document.getElementById('main-content').style.visibility = 'visible';
                initializePage();
            })
            .catch(error => {
                console.error('Validation Error:', error);
                document.body.innerHTML = `<main class="container"><h1>Ошибка авторизации</h1><p>${error.message}</p></main>`;
            });
        }
        
        function initializePage() {
            // Эта функция выполняется только ПОСЛЕ успешной авторизации
            loadEmployees();
            setupDateSelector();
            document.getElementById('report-form').addEventListener('submit', handleReportFormSubmit);
            document.getElementById('employees-tbody').addEventListener('click', handleEmployeeAction);
        }

        // --- ЛОГИКА ДЛЯ СПИСКА СОТРУДНИКОВ ---
        function loadEmployees() {
            const loadingDiv = document.getElementById('loading-employees');
            const table = document.getElementById('employees-table');
            const tbody = document.getElementById('employees-tbody');

            loadingDiv.style.display = 'block';
            table.style.display = 'none';

            fetch('/api/employees')
                .then(response => response.json())
                .then(data => {
                    loadingDiv.style.display = 'none';
                    table.style.display = 'table';
                    tbody.innerHTML = '';
                    data.forEach(employee => {
                        const row = document.createElement('tr');
                        row.dataset.employeeId = employee.id;
                        row.innerHTML = `
                            <td>${employee.id}</td>
                            <td>${employee.full_name}</td>
                            <td>
                                <button class="delete-btn" data-action="deactivate" data-id="${employee.id}">
                                    Удалить
                                </button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                })
                .catch(error => {
                    loadingDiv.textContent = 'Ошибка загрузки сотрудников!';
                    console.error('Error fetching employees:', error);
                });
        }
        
        // ИСПРАВЛЕНИЕ: Полностью переписана функция для корректной работы
        function handleEmployeeAction(event) {
            const targetButton = event.target.closest('button');
            if (!targetButton || targetButton.dataset.action !== 'deactivate') {
                return;
            }

            const employeeId = targetButton.dataset.id;
            const employeeRow = targetButton.closest('tr');
            const employeeName = employeeRow.cells[1].textContent;

            if (confirm(`Вы уверены, что хотите деактивировать сотрудника ${employeeName}?`)) {
                targetButton.setAttribute('aria-busy', 'true');
                targetButton.disabled = true;

                fetch('/api/employees/deactivate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: parseInt(employeeId) })
                })
                .then(response => {
                    if (!response.ok) throw new Error('Ошибка сервера при деактивации');
                    return response.json();
                })
                .then(result => {
                    if (result.status === 'success') {
                        // Просто перезагружаем список сотрудников, чтобы он был актуальным
                        loadEmployees(); 
                    } else {
                        throw new Error(result.message || 'Неизвестная ошибка');
                    }
                })
                .catch(error => {
                    alert(`Не удалось деактивировать сотрудника: ${error.message}`);
                    targetButton.removeAttribute('aria-busy');
                    targetButton.disabled = false;
                });
            }
        }
        
        // --- ЛОГИКА ДЛЯ ОТЧЕТА (без изменений) ---
        function setupDateSelector() {
            const monthSelect = document.getElementById('month-select');
            const yearSelect = document.getElementById('year-select');
            const months = ["Январь", "Февраль", "Март", "Апрель", "Май", "Июнь", "Июль", "Август", "Сентябрь", "Октябрь", "Ноябрь", "Декабрь"];
            const currentYear = new Date().getFullYear();
            const currentMonth = new Date().getMonth();

            months.forEach((monthName, index) => {
                const option = new Option(monthName, index + 1);
                if (index === currentMonth) option.selected = true;
                monthSelect.add(option);
            });

            for (let i = currentYear; i >= currentYear - 2; i--) {
                yearSelect.add(new Option(i, i));
            }
        }

        function handleReportFormSubmit(event) {
            event.preventDefault();
            const year = document.getElementById('year-select').value;
            const month = document.getElementById('month-select').value;
            
            const loadingDiv = document.getElementById('report-loading');
            const errorDiv = document.getElementById('report-error');
            const table = document.getElementById('report-table');

            loadingDiv.style.display = 'block';
            errorDiv.style.display = 'none';
            table.innerHTML = '';

            fetch(`/api/reports/monthly/${year}/${month}`)
                .then(response => {
                    if (!response.ok) return response.json().then(err => { throw new Error(err.detail) });
                    return response.json();
                })
                .then(result => {
                    loadingDiv.style.display = 'none';
                    renderReportTable(result.data);
                })
                .catch(error => {
                    loadingDiv.style.display = 'none';
                    errorDiv.textContent = `Не удалось загрузить отчет: ${error.message}`;
                    errorDiv.style.display = 'block';
                    console.error('Error fetching report:', error);
                });
        }

        function renderReportTable(reportData) {
            const table = document.getElementById('report-table');
            const thead = document.createElement('thead');
            const tbody = document.createElement('tbody');
            
            const headerRow = document.createElement('tr');
            reportData[0].forEach(headerText => {
                const th = document.createElement('th');
                th.textContent = headerText;
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);

            reportData.slice(1).forEach(rowData => {
                const row = document.createElement('tr');
                rowData.forEach((cellData, index) => {
                    const cell = document.createElement('td');
                    cell.textContent = cellData;
                    
                    if (index > 0) {
                        const status = cellData.toLowerCase();
                        if (status.includes('опоздал')) cell.className = 'status-late';
                        else if (status.includes('прогул') || status.includes('пропустил')) cell.className = 'status-absent';
                        else if (status.includes('отпуск') || status.includes('больничный') || status.includes('отпросился')) cell.className = 'status-leave';
                    }
                    row.appendChild(cell);
                });
                tbody.appendChild(row);
            });

            table.appendChild(thead);
            table.appendChild(tbody);
        }
    </script>
</body>
</html>