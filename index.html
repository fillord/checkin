<!DOCTYPE html>
<html lang="ru" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Админ-панель</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
    <style>
        body {
            font-size: 16px;
        }
        main {
            padding-bottom: 2rem;
        }
        #report-container { overflow-x: auto; }
        .status-ontime { background-color: #2a9d8f}
        .status-late { background-color: #e76f51}
        .status-absent { background-color: #e63946}
        .status-leave { background-color: #5252b9}
        .status-holiday { background-color: #8349a9}
        .status-dayoff { background-color: #38514e }
        .action-btn { 
            --pico-font-size: 0.85em; 
            --pico-padding: 0.3em 0.6em;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .delete-btn { 
            background-color: var(--pico-color-red-500); 
            border-color: var(--pico-color-red-550);
        }
        .delete-btn:hover { 
            background-color: var(--pico-color-red-600); 
            border-color: var(--pico-color-red-650); 
        }
        .modal-body { 
            max-height: 80vh; 
            overflow-y: auto; 
        }
        th[data-sort] {
            cursor: pointer;
            user-select: none;
        }
        th[data-sort]:hover {
            background-color: var(--pico-hocus-background-color);
        }
        th.sort-asc::after {
            content: ' ▲';
            font-size: 0.8em;
        }
        th.sort-desc::after {
            content: ' ▼';
            font-size: 0.8em;
        }
        #report-table th:first-child,
        #report-table td:first-child {
            position: -webkit-sticky;
            position: sticky;
            left: 0;
            background-color: var(--pico-card-background-color);
        }
        #report-table thead th {
            z-index: 3;
        }
        
        #report-table td:first-child {
            z-index: 1;
        }
        #holidays-list li { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
        #holidays-list span { flex-grow: 1; }
        #holidays-list button { margin-left: 1rem; }
    </style>
</head>
<body>
    <div id="main-content" style="visibility: hidden;">
        <main class="container">
            <header>
                <h1>Админ-панель бота</h1>
            </header>

            <details open>
                <summary><strong>Список сотрудников</strong></summary>
                
                <div class="grid">
                    <input type="search" id="search-input" name="search" placeholder="Поиск по ФИО...">
                    <button id="add-employee-btn" data-target="add-employee-modal">➕ Добавить сотрудника</button>
                </div>

                <div id="loading-employees" aria-busy="true">Загрузка данных...</div>
                <table id="employees-table" style="display: none;">
                    <thead>
                        <tr>
                            <th data-sort="telegram_id">ID</th>
                            <th data-sort="full_name" class="sort-asc">ФИО</th>
                            <th>Действия</th>
                        </tr>
                    </thead>
                    <tbody id="employees-tbody"></tbody>
                </table>
            </details>

            <details>
                <summary><strong>Управление праздниками</strong></summary>
                <div class="grid">
                    <label for="holiday-year-select">
                        Год
                        <select id="holiday-year-select"></select>
                    </label>
                </div>
                <div id="holidays-loading" aria-busy="true" style="display: none;">Загрузка праздников...</div>
                <ul id="holidays-list"></ul>
                <form id="add-holiday-form" style="margin-top: 1rem;">
                    <fieldset class="grid">
                        <input type="date" id="new-holiday-date" required>
                        <input type="text" id="new-holiday-name" placeholder="Название праздника" required>
                        <button type="submit">Добавить праздник</button>
                    </fieldset>
                </form>
            </details>

            <details open>
                <summary><strong>Сводный отчет за месяц</strong></summary>
                <form id="report-form">
                    <div class="grid">
                        <select id="month-select" required></select>
                        <select id="year-select" required></select>
                        <button type="submit">Сформировать</button>
                    </div>
                </form>
                <div id="report-container" style="margin-top: 1rem;">
                    <div id="report-loading" aria-busy="true" style="display: none;">Формирование отчета...</div>
                    <div id="report-error" style="color: var(--pico-color-red); display: none;"></div>
                    <table id="report-table"></table>
                </div>
            </details>
        </main>
    </div>
    
    <dialog id="log-modal">
        <article>
            <header>
                <a href="#close" aria-label="Close" class="close" data-target="log-modal"></a>
                <strong id="log-modal-header">История событий</strong>
            </header>
            
            <form id="log-form">
                <input type="hidden" id="log-employee-id">
                <div class="grid">
                    <input type="date" id="log-start-date" required>
                    <input type="date" id="log-end-date" required>
                    <button type="submit">Показать</button>
                </div>
            </form>

            <div id="log-loading" aria-busy="true" style="display: none;">Загрузка истории...</div>
            <div id="log-error" style="color: var(--pico-color-red); display: none;"></div>
            <div style="max-height: 50vh; overflow-y: auto; margin-top: 1rem;">
                <table id="log-table">
                    <thead><tr><th>Время</th><th>Тип</th><th>Статус</th><th>Детали</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </article>
    </dialog>

    <dialog id="add-employee-modal">
        <article class="modal-body">
            <header>
                <a href="#close" aria-label="Close" class="close" data-target="add-employee-modal"></a>
                <strong>Новый сотрудник</strong>
            </header>
            <form id="add-employee-form">
                <label for="new-employee-id">Telegram ID</label>
                <input type="number" id="new-employee-id" required>

                <label for="new-employee-name">ФИО</label>
                <input type="text" id="new-employee-name" required>

                <label for="new-effective-date">График действует с даты</label>
                <input type="date" id="new-effective-date" required>
                
                <p><strong>График работы</strong> (в формате `09:00-18:00`, для выходного введите `0`)</p>
                <div class="grid">
                    <label>ПН <input type="text" class="schedule-input" data-day="0" placeholder="09:00-18:00"></label>
                    <label>ВТ <input type="text" class="schedule-input" data-day="1" placeholder="09:00-18:00"></label>
                </div>
                <div class="grid">
                    <label>СР <input type="text" class="schedule-input" data-day="2" placeholder="09:00-18:00"></label>
                    <label>ЧТ <input type="text" class="schedule-input" data-day="3" placeholder="09:00-18:00"></label>
                </div>
                <div class="grid">
                    <label>ПТ <input type="text" class="schedule-input" data-day="4" placeholder="09:00-18:00"></label>
                    <label>СБ <input type="text" class="schedule-input" data-day="5" placeholder="0"></label>
                </div>
                <div class="grid">
                    <label>ВС <input type="text" class="schedule-input" data-day="6" placeholder="0"></label>
                </div>
                
                <p id="add-employee-error" style="color: var(--pico-color-red); display: none;"></p>
                <footer>
                    <button type="submit">✅ Сохранить</button>
                </footer>
            </form>
        </article>
    </dialog>
    
    <dialog id="edit-employee-modal">
        <article class="modal-body">
            <header>
                <a href="#close" aria-label="Close" class="close" data-target="edit-employee-modal"></a>
                <strong id="edit-modal-header">Редактирование сотрудника</strong>
            </header>
            <div id="edit-form-loading" aria-busy="true" style="display: none;">Загрузка данных сотрудника...</div>
            <form id="edit-employee-form" style="display: none;">
                <input type="hidden" id="edit-employee-original-id">
                
                <label for="edit-employee-id">Telegram ID (нельзя изменить)</label>
                <input type="number" id="edit-employee-id" readonly>

                <label for="edit-employee-name">ФИО</label>
                <input type="text" id="edit-employee-name" required>

                <label for="edit-effective-date">Применить новый график с даты</label>
                <input type="date" id="edit-effective-date" required>
                
                <p><strong>График работы</strong> (в формате `09:00-18:00`, для выходного введите `0`)</p>
                <div class="grid">
                    <label>ПН <input type="text" class="edit-schedule-input" data-day="0"></label>
                    <label>ВТ <input type="text" class="edit-schedule-input" data-day="1"></label>
                </div>
                <div class="grid">
                    <label>СР <input type="text" class="edit-schedule-input" data-day="2"></label>
                    <label>ЧТ <input type="text" class="edit-schedule-input" data-day="3"></label>
                </div>
                <div class="grid">
                    <label>ПТ <input type="text" class="edit-schedule-input" data-day="4"></label>
                    <label>СБ <input type="text" class="edit-schedule-input" data-day="5"></label>
                </div>
                <div class="grid">
                    <label>ВС <input type="text" class="edit-schedule-input" data-day="6"></label>
                </div>
                
                <p id="edit-employee-error" style="color: var(--pico-color-red); display: none;"></p>
                <footer>
                    <button type="submit">💾 Сохранить изменения</button>
                </footer>
            </form>
        </article>
    </dialog>

    <dialog id="leave-modal">
        <article class="modal-body">
            <header>
                <a href="#close" aria-label="Close" class="close" data-target="leave-modal"></a>
                <strong id="leave-modal-header">Управление отсутствием</strong>
            </header>
            <form id="leave-form">
                <input type="hidden" id="leave-employee-id">
                <label for="leave-type">Тип отсутствия</label>
                <select id="leave-type" required>
                    <option value="Отпуск">Отпуск</option>
                    <option value="Больничный">Больничный</option>
                </select>
                <div class="grid">
                    <label for="start-date">
                        Начало периода
                        <input type="date" id="start-date" required>
                    </label>
                    <label for="end-date">
                        Конец периода
                        <input type="date" id="end-date" required>
                    </label>
                </div>
                <p id="leave-error" style="color: var(--pico-color-red); display: none;"></p>
                <footer>
                    <div class="grid">
                        <button type="submit" data-action="add-leave">✅ Назначить</button>
                        <button type="button" class="secondary" data-action="cancel-leave">🚫 Отменить за период</button>
                    </div>
                </footer>
            </form>
        </article>
    </dialog>

    <dialog id="replacement-modal">
        <article class="modal-body">
            <header>
                <a href="#close" aria-label="Close" class="close" data-target="replacement-modal"></a>
                <strong id="replacement-modal-header">Временная замена</strong>
            </header>
            <form id="replacement-form">
                <input type="hidden" id="replacement-original-id">

                <label for="replacement-original-name">Сотрудник, которого заменяют</label>
                <input type="text" id="replacement-original-name" readonly>

                <label for="substitute-select">Кто будет заменять</label>
                <select id="substitute-select" required>
                    <option value="">Загрузка...</option>
                </select>

                <div class="grid">
                    <label for="replacement-start-date">
                        Начало периода
                        <input type="date" id="replacement-start-date" required>
                    </label>
                    <label for="replacement-end-date">
                        Конец периода
                        <input type="date" id="replacement-end-date" required>
                    </label>
                </div>
                <p id="replacement-error" style="color: var(--pico-color-red); display: none;"></p>
                <footer>
                    <button type="submit">✅ Назначить замену</button>
                </footer>
            </form>
        </article>
    </dialog>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        const tg = window.Telegram.WebApp;
        let viewState = {
            searchQuery: '',
            sortBy: 'full_name',
            sortOrder: 'asc'
        };
        let debounceTimer;
        async function apiFetch(url, options = {}) {
            const defaultHeaders = {
                'Content-Type': 'application/json',
                'X-Telegram-Init-Data': tg.initData 
            };
            
            const config = { ...options, headers: { ...defaultHeaders, ...options.headers } };

            const response = await fetch(url, config);
            if (!response.ok) {
                try {
                    const err = await response.json();
                    throw new Error(err.detail || `Ошибка ${response.status}`);
                } catch (e) {
                    throw new Error(`Ошибка сети: ${response.statusText || response.status}`);
                }
            }
            const contentType = response.headers.get("content-type");
            if (contentType && contentType.indexOf("application/json") !== -1) {
                return response.json();
            }
            return; 
        }
        document.addEventListener('DOMContentLoaded', () => {
            tg.ready();
            validateUserOnLoad();
        });

        function validateUserOnLoad() {
            if (!tg.initData) {
                document.body.innerHTML = '<main class="container"><h1>Доступ запрещен.</h1><p>Пожалуйста, откройте эту панель через вашего Telegram-бота.</p></main>';
                return;
            }
            fetch('/api/validate_user', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ initData: tg.initData })
            })
            .then(response => {
                if (!response.ok) throw new Error('Авторизация не пройдена!');
                return response.json();
            })
            .then(() => {
                document.getElementById('main-content').style.visibility = 'visible';
                initializePage();
            })
            .catch(error => {
                console.error('Validation Error:', error);
                document.body.innerHTML = `<main class="container"><h1>Ошибка авторизации</h1><p>${error.message}</p></main>`;
            });
        }
        
        function initializePage() {
            loadEmployees();
            setupDateSelector();
            setupHolidayManager();
            document.getElementById('add-employee-btn').addEventListener('click', () => document.getElementById('add-employee-modal').showModal());
            document.getElementById('add-employee-form').addEventListener('submit', handleAddEmployeeSubmit);
            document.getElementById('edit-employee-form').addEventListener('submit', handleEditEmployeeSubmit);
            document.getElementById('search-input').addEventListener('input', handleSearchInput);
            document.querySelector('#employees-table thead').addEventListener('click', handleSortClick);
            document.getElementById('employees-tbody').addEventListener('click', handleEmployeeActionClick);
            document.getElementById('report-form').addEventListener('submit', handleReportFormSubmit);
            document.getElementById('replacement-form').addEventListener('submit', handleReplacementFormSubmit);
            document.querySelector("#leave-form button[data-action='add-leave']").addEventListener('click', (e) => handleLeaveFormSubmit(e, 'add-leave'));
            document.querySelector("#leave-form button[data-action='cancel-leave']").addEventListener('click', (e) => handleLeaveFormSubmit(e, 'cancel-leave'));
            
            document.getElementById('holiday-year-select').addEventListener('change', loadHolidays);
            document.getElementById('add-holiday-form').addEventListener('submit', handleAddHoliday);
            document.getElementById('holidays-list').addEventListener('click', handleDeleteHoliday);
            document.getElementById('log-form').addEventListener('submit', handleLogFormSubmit);
            document.addEventListener('click', (e) => {
                if(e.target.matches(".close")) {
                    e.preventDefault();
                    document.getElementById(e.target.dataset.target).close();
                }
            });
        }
        
        function setupHolidayManager() {
            const yearSelect = document.getElementById('holiday-year-select');
            const currentYear = new Date().getFullYear();
            for (let i = currentYear + 1; i >= currentYear - 2; i--) {
                const option = new Option(i, i);
                if (i === currentYear) option.selected = true;
                yearSelect.add(option);
            }
            loadHolidays();
        }
        function loadHolidays() {
            const year = document.getElementById('holiday-year-select').value;
            const list = document.getElementById('holidays-list');
            const loading = document.getElementById('holidays-loading');
            
            list.innerHTML = '';
            loading.style.display = 'block';

            apiFetch(`/api/holidays/${year}`)
                .then(data => {
                    if (!data || data.length === 0) return;
                    data.forEach(holiday => {
                        const li = document.createElement('li');
                        const span = document.createElement('span');
                        const strong = document.createElement('strong');
                        
                        strong.textContent = new Date(holiday.holiday_date).toLocaleDateString('ru-RU');
                        span.append(strong);
                        span.append(document.createTextNode(` - ${holiday.holiday_name}`));

                        const button = document.createElement('button');
                        button.className = "secondary outline";
                        button.dataset.date = holiday.holiday_date;
                        button.textContent = "Удалить";
                        
                        li.append(span, button);
                        list.appendChild(li);
                    });
                })
                .catch(error => console.error("Ошибка загрузки праздников:", error.message))
                .finally(() => loading.style.display = 'none');
        }

        function handleAddHoliday(event) {
            event.preventDefault();
            const date = document.getElementById('new-holiday-date').value;
            const name = document.getElementById('new-holiday-name').value;
            if (!date || !name) {
                alert('Пожалуйста, заполните дату и название праздника.');
                return;
            }
            
            apiFetch('/api/holidays/add', {
                method: 'POST',
                body: JSON.stringify({ holiday_date: date, holiday_name: name })
            })
            .then(() => {
                document.getElementById('add-holiday-form').reset();
                loadHolidays();
            })
            .catch(error => alert(error.message));
        }

        function handleDeleteHoliday(event) {
            if (event.target.tagName !== 'BUTTON') return;
            const date = event.target.dataset.date;
            if (!confirm(`Вы уверены, что хотите удалить праздник ${date}?`)) return;

            apiFetch('/api/holidays/delete', {
                method: 'POST',
                body: JSON.stringify({ holiday_date: date })
            })
            .then(() => loadHolidays())
            .catch(error => alert(error.message));
        }
        
        function handleAddEmployeeSubmit(event) {
            event.preventDefault();
            const form = event.target;
            const submitButton = form.querySelector('button[type="submit"]');
            const errorDiv = document.getElementById('add-employee-error');
            errorDiv.style.display = 'none';

            const schedule = {};
            let isScheduleValid = true;
            const timePattern = /^([01]\d|2[0-3]):([0-5]\d)-([01]\d|2[0-3]):([0-5]\d)$/;
            
            form.querySelectorAll('.schedule-input').forEach(input => {
                const day = input.dataset.day;
                const value = input.value.trim();
                input.setAttribute('aria-invalid', 'false');
                if (value === '0' || value === '') {
                    schedule[day] = {};
                } else if (timePattern.test(value)) {
                    const [start, end] = value.split('-');
                    schedule[day] = { start, end };
                } else {
                    isScheduleValid = false;
                    input.setAttribute('aria-invalid', 'true');
                }
            });

            if (!isScheduleValid) {
                errorDiv.textContent = 'Ошибка: Неверный формат времени в графике. Используйте ЧЧ:ММ-ЧЧ:ММ или 0.';
                errorDiv.style.display = 'block';
                return;
            }

            const requestBody = {
                telegram_id: parseInt(document.getElementById('new-employee-id').value),
                full_name: document.getElementById('new-employee-name').value,
                effective_date: document.getElementById('new-effective-date').value,
                schedule: schedule
            };

            if (!requestBody.telegram_id || !requestBody.full_name || !requestBody.effective_date) {
                errorDiv.textContent = 'Ошибка: Пожалуйста, заполните все поля: ID, ФИО и дату.';
                errorDiv.style.display = 'block';
                return;
            }

            submitButton.setAttribute('aria-busy', 'true');
            submitButton.disabled = true;

            apiFetch('/api/employees/add', {
                method: 'POST',
                body: JSON.stringify(requestBody)
            })
            .then(result => {
                alert(`Успешно: ${result.message}`);
                document.getElementById('add-employee-modal').close();
                form.reset();
                loadEmployees();
            })
            .catch(error => {
                errorDiv.textContent = `Ошибка: ${error.message}`;
                errorDiv.style.display = 'block';
            })
            .finally(() => {
                submitButton.removeAttribute('aria-busy');
                submitButton.disabled = false;
            });
        }

        function handleEditEmployeeSubmit(event) {
            event.preventDefault();
            const form = event.target;
            const submitButton = form.querySelector('button[type="submit"]');
            const errorDiv = document.getElementById('edit-employee-error');
            errorDiv.style.display = 'none';

            const schedule = {};
            let isScheduleValid = true;
            const timePattern = /^([01]\d|2[0-3]):([0-5]\d)-([01]\d|2[0-3]):([0-5]\d)$/;
            
            form.querySelectorAll('.edit-schedule-input').forEach(input => {
                const day = input.dataset.day;
                const value = input.value.trim();
                input.setAttribute('aria-invalid', 'false');
                if (value === '0' || value === '') {
                    schedule[day] = {};
                } else if (timePattern.test(value)) {
                    const [start, end] = value.split('-');
                    schedule[day] = { start, end };
                } else {
                    isScheduleValid = false;
                    input.setAttribute('aria-invalid', 'true');
                }
            });

            if (!isScheduleValid) {
                errorDiv.textContent = 'Ошибка: Неверный формат времени в графике. Используйте ЧЧ:ММ-ЧЧ:ММ или 0.';
                errorDiv.style.display = 'block';
                return;
            }

            const requestBody = {
                telegram_id: parseInt(document.getElementById('edit-employee-id').value),
                full_name: document.getElementById('edit-employee-name').value,
                effective_date: document.getElementById('edit-effective-date').value,
                schedule: schedule
            };
            
            submitButton.setAttribute('aria-busy', 'true');
            submitButton.disabled = true;

            apiFetch('/api/employees/update', {
                method: 'POST',
                body: JSON.stringify(requestBody)
            })
            .then(result => {
                alert(`Успешно: ${result.message}`);
                document.getElementById('edit-employee-modal').close();
                loadEmployees();
            })
            .catch(error => {
                errorDiv.textContent = `Ошибка: ${error.message}`;
                errorDiv.style.display = 'block';
            })
            .finally(() => {
                submitButton.removeAttribute('aria-busy');
                submitButton.disabled = false;
            });
        }
        
        function handleSearchInput(event) {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                viewState.searchQuery = event.target.value;
                loadEmployees();
            }, 350);
        }

        function handleSortClick(event) {
            const header = event.target.closest('th');
            if (header && header.dataset.sort) {
                const newSortBy = header.dataset.sort;
                if (viewState.sortBy === newSortBy) {
                    viewState.sortOrder = viewState.sortOrder === 'asc' ? 'desc' : 'asc';
                } else {
                    viewState.sortBy = newSortBy;
                    viewState.sortOrder = 'asc';
                }
                loadEmployees();
            }
        }

        function updateSortIndicators() {
            document.querySelectorAll('#employees-table th[data-sort]').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
            });
            const activeHeader = document.querySelector(`#employees-table th[data-sort="${viewState.sortBy}"]`);
            if (activeHeader) {
                activeHeader.classList.add(viewState.sortOrder === 'asc' ? 'sort-asc' : 'sort-desc');
            }
        }
        function loadEmployees() {
            const loadingDiv = document.getElementById('loading-employees');
            const table = document.getElementById('employees-table');
            const tbody = document.getElementById('employees-tbody');
            loadingDiv.style.display = 'block';
            table.style.display = 'none';

            const params = new URLSearchParams({
                sort_by: viewState.sortBy,
                sort_order: viewState.sortOrder
            });
            if (viewState.searchQuery) {
                params.append('q', viewState.searchQuery);
            }
            const apiUrl = `/api/employees?${params.toString()}`;

            apiFetch(apiUrl)
                .then(data => {
                    loadingDiv.style.display = 'none';
                    table.style.display = 'table';
                    tbody.innerHTML = '';
                    
                    data.forEach(employee => {
                        const row = tbody.insertRow();
                        row.dataset.employeeId = employee.id;

                        row.insertCell().textContent = employee.id;
                        row.insertCell().textContent = employee.full_name;
                        
                        const actionsCell = row.insertCell();
                        const createBtn = (text, action, id, name, isDelete = false) => {
                            const btn = document.createElement('button');
                            btn.textContent = text;
                            btn.className = 'action-btn';
                            if (isDelete) btn.classList.add('delete-btn');
                            btn.dataset.action = action;
                            btn.dataset.id = id;
                            if (name) btn.dataset.name = name;
                            return btn;
                        };
                        
                        actionsCell.append(
                            createBtn('История', 'view_log', employee.id, employee.full_name),
                            createBtn('Изменить', 'edit', employee.id, employee.full_name),
                            createBtn('Отсутствие', 'manage-leave', employee.id, employee.full_name),
                            createBtn('Замена', 'replacement', employee.id, employee.full_name),
                            createBtn('Удалить', 'deactivate', employee.id, employee.full_name, true)
                        );
                    });
                    updateSortIndicators();
                })
                .catch(error => {
                    loadingDiv.textContent = 'Ошибка загрузки сотрудников!';
                });
        }
        
        function handleEmployeeActionClick(event) {
            const targetButton = event.target.closest('button');
            if (!targetButton) return;

            const action = targetButton.dataset.action;
            const employeeId = targetButton.dataset.id;
            const employeeName = targetButton.dataset.name;

            if (action === 'deactivate') {
                if (confirm(`Вы уверены, что хотите деактивировать сотрудника ${employeeName}?`)) {
                    deactivateEmployee(employeeId, targetButton);
                }
            } else if (action === 'manage-leave') {
                const modal = document.getElementById('leave-modal');
                document.getElementById('leave-modal-header').textContent = `Отсутствие: ${employeeName}`;
                document.getElementById('leave-employee-id').value = employeeId;
                modal.showModal();
            } else if (action === 'edit') {
                openEditModalFor(employeeId);
            } else if (action === 'view_log') {
                openLogModalFor(employeeId, employeeName);   
            } else if (action === 'replacement') {
                openReplacementModalFor(employeeId, employeeName);
            }
        }

        function openLogModalFor(employeeId, employeeName) {
            const modal = document.getElementById('log-modal');
            document.getElementById('log-modal-header').textContent = `История: ${employeeName}`;
            document.getElementById('log-employee-id').value = employeeId;
            
            const today = new Date();
            const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            document.getElementById('log-start-date').valueAsDate = startOfMonth;
            document.getElementById('log-end-date').valueAsDate = today;

            modal.showModal();
            document.getElementById('log-form').requestSubmit();
        }
        function handleLogFormSubmit(event) {
            event.preventDefault();
            const employeeId = document.getElementById('log-employee-id').value;
            const startDate = document.getElementById('log-start-date').value;
            const endDate = document.getElementById('log-end-date').value;

            const loading = document.getElementById('log-loading');
            const errorDiv = document.getElementById('log-error');
            const tableBody = document.querySelector('#log-table tbody');

            loading.style.display = 'block';
            errorDiv.style.display = 'none';
            tableBody.innerHTML = '';

            apiFetch(`/api/employees/${employeeId}/log?start_date=${startDate}&end_date=${endDate}`)
            .then(data => {
                if (data.length === 0) {
                    const row = tableBody.insertRow();
                    const cell = row.insertCell();
                    cell.colSpan = 4;
                    cell.textContent = 'Нет событий за выбранный период.';
                    return;
                }
                data.forEach(log => {
                    const row = tableBody.insertRow();
                    row.insertCell().textContent = log.timestamp;
                    row.insertCell().textContent = log.check_in_type;
                    row.insertCell().textContent = log.status;
                    
                    let details = '';
                    if (log.distance_meters !== null) details += `Расстояние: ${log.distance_meters}м. `;
                    if (log.face_similarity !== null) details += `Схожесть: ${log.face_similarity.toFixed(1)}%`;
                    row.insertCell().textContent = details || '-';
                });
            })
            .catch(error => {
                errorDiv.textContent = `Ошибка: ${error.message}`;
                errorDiv.style.display = 'block';
            })
            .finally(() => {
                loading.style.display = 'none';
            });
        }

        function openEditModalFor(employeeId) {
            const modal = document.getElementById('edit-employee-modal');
            const form = document.getElementById('edit-employee-form');
            const loading = document.getElementById('edit-form-loading');
            const errorDiv = document.getElementById('edit-employee-error');
            
            form.style.display = 'none';
            loading.style.display = 'block';
            errorDiv.style.display = 'none';
            modal.showModal();

            apiFetch(`/api/employees/${employeeId}`)
                .then(data => {
                    document.getElementById('edit-employee-id').value = data.telegram_id;
                    document.getElementById('edit-employee-name').value = data.full_name;
                    document.getElementById('edit-effective-date').value = new Date().toISOString().split('T')[0];

                    form.querySelectorAll('.edit-schedule-input').forEach(input => {
                        const day = input.dataset.day;
                        input.value = data.schedule[day] || '0';
                    });

                    loading.style.display = 'none';
                    form.style.display = 'block';
                })
                .catch(err => {
                    loading.style.display = 'none';
                    errorDiv.textContent = err.message;
                    errorDiv.style.display = 'block';
                });
        }
        
        function deactivateEmployee(id, button) {
            button.setAttribute('aria-busy', 'true');
            button.disabled = true;
            apiFetch('/api/employees/deactivate', {
                method: 'POST',
                body: JSON.stringify({ id: parseInt(id) })
            })
            .then(() => loadEmployees())
            .catch(error => {
                alert(`Не удалось деактивировать: ${error.message}`);
                button.removeAttribute('aria-busy');
                button.disabled = false;
            });
        }

        function handleLeaveFormSubmit(event, action) {
            event.preventDefault(); // Предотвращаем стандартную отправку формы
            
            const form = event.target.closest('form');
            const actionButton = form.querySelector(`button[data-action='${action}']`);
            const errorDiv = document.getElementById('leave-error');
            const apiUrl = (action === 'add-leave') ? '/api/leaves/add' : '/api/leaves/cancel';

            const requestBody = {
                employee_id: parseInt(document.getElementById('leave-employee-id').value),
                leave_type: document.getElementById('leave-type').value,
                start_date: document.getElementById('start-date').value,
                end_date: document.getElementById('end-date').value
            };

            if (!requestBody.start_date || !requestBody.end_date) {
                errorDiv.textContent = 'Ошибка: Пожалуйста, выберите начальную и конечную дату.';
                errorDiv.style.display = 'block';
                return;
            }

            actionButton.setAttribute('aria-busy', 'true');
            actionButton.disabled = true;
            errorDiv.style.display = 'none';

            apiFetch(apiUrl, {
                method: 'POST',
                body: JSON.stringify(requestBody)
            })
            .then(result => {
                alert(`Успешно: ${result.message}`);
                document.getElementById('leave-modal').close();
                document.getElementById('leave-form').reset();
            })
            .catch(error => {
                errorDiv.textContent = `Ошибка: ${error.message}`;
                errorDiv.style.display = 'block';
            })
            .finally(() => {
                actionButton.removeAttribute('aria-busy');
                actionButton.disabled = false;
            });
        }
        
        function setupDateSelector() {
            const monthSelect = document.getElementById('month-select');
            const yearSelect = document.getElementById('year-select');
            const months = ["Январь", "Февраль", "Март", "Апрель", "Май", "Июнь", "Июль", "Август", "Сентябрь", "Октябрь", "Ноябрь", "Декабрь"];
            const currentYear = new Date().getFullYear();
            const currentMonth = new Date().getMonth();

            months.forEach((monthName, index) => {
                const option = new Option(monthName, index + 1);
                if (index === currentMonth) option.selected = true;
                monthSelect.add(option);
            });

            for (let i = currentYear; i >= currentYear - 2; i--) {
                yearSelect.add(new Option(i, i));
            }
        }

        function handleReportFormSubmit(event) {
            event.preventDefault();
            const year = document.getElementById('year-select').value;
            const month = document.getElementById('month-select').value;
            
            const loadingDiv = document.getElementById('report-loading');
            const errorDiv = document.getElementById('report-error');
            const table = document.getElementById('report-table');

            loadingDiv.style.display = 'block';
            errorDiv.style.display = 'none';
            table.innerHTML = '';

            apiFetch(`/api/reports/monthly/${year}/${month}`)
                .then(result => {
                    loadingDiv.style.display = 'none';
                    if (result.data.length === 0) {
                        errorDiv.textContent = 'Нет данных за выбранный период.';
                        errorDiv.style.display = 'block';
                        return;
                    }
                    renderReportTable(result.data);
                })
                .catch(error => {
                    loadingDiv.style.display = 'none';
                    errorDiv.textContent = `Не удалось загрузить отчет: ${error.message}`;
                    errorDiv.style.display = 'block';
                });
        }

        function renderReportTable(reportData) {
            const table = document.getElementById('report-table');
            const thead = document.createElement('thead');
            const tbody = document.createElement('tbody');
            
            const headerRow = document.createElement('tr');
            reportData[0].forEach(headerText => {
                const th = document.createElement('th');
                th.textContent = headerText;
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);

            reportData.slice(1).forEach(rowData => {
                const row = document.createElement('tr');
                rowData.forEach((cellData, index) => {
                    const cell = document.createElement('td');
                    cell.textContent = cellData;
                    if (index > 0) { 
                        const status = cellData.toLowerCase();
                        if (status.includes('прогул') || status.includes('пропустил') || status.includes('не завершил')) {
                            cell.className = 'status-absent';
                        } else if (status.includes('опоздал')) {
                            cell.className = 'status-late';
                        } else if (status.includes('отпуск') || status.includes('больничный') || status.includes('отпросился')) {
                            cell.className = 'status-leave';
                        } else if (status.includes('вовремя')) {
                            cell.className = 'status-ontime';
                        } else if (status.includes('праздник')) {
                            cell.className = 'status-holiday';
                        } else if (status.includes('выходной')) {
                            cell.className = 'status-dayoff';
                        }
                    }
                    row.appendChild(cell);
                });
                tbody.appendChild(row);
            });

            table.appendChild(thead);
            table.appendChild(tbody);
        }
    function openReplacementModalFor(employeeId, employeeName) {
        const modal = document.getElementById('replacement-modal');
        document.getElementById('replacement-modal-header').textContent = `Замена для: ${employeeName}`;
        document.getElementById('replacement-original-id').value = employeeId;
        document.getElementById('replacement-original-name').value = employeeName;

        const substituteSelect = document.getElementById('substitute-select');
        substituteSelect.innerHTML = '<option value="">Загрузка списка...</option>';
        substituteSelect.disabled = true;

        modal.showModal();

        // Загружаем список всех сотрудников для выбора
        apiFetch('/api/employees')
            .then(employees => {
                substituteSelect.innerHTML = '<option value="">-- Выберите сотрудника --</option>';
                employees.forEach(emp => {
                    // Нельзя выбрать самого себя в качестве замены
                    if (emp.id !== parseInt(employeeId)) {
                        const option = new Option(emp.full_name, emp.id);
                        substituteSelect.add(option);
                    }
                });
                substituteSelect.disabled = false;
            })
            .catch(error => {
                substituteSelect.innerHTML = `<option value="">Ошибка загрузки</option>`;
                console.error("Ошибка загрузки сотрудников для замены:", error);
            });
    }

    function handleReplacementFormSubmit(event) {
        event.preventDefault();
        const form = event.target;
        const submitButton = form.querySelector('button[type="submit"]');
        const errorDiv = document.getElementById('replacement-error');
        errorDiv.style.display = 'none';

        const requestBody = {
            original_employee_id: parseInt(document.getElementById('replacement-original-id').value),
            substitute_employee_id: parseInt(document.getElementById('substitute-select').value),
            start_date: document.getElementById('replacement-start-date').value,
            end_date: document.getElementById('replacement-end-date').value
        };

        if (!requestBody.substitute_employee_id || !requestBody.start_date || !requestBody.end_date) {
            errorDiv.textContent = 'Ошибка: Пожалуйста, заполните все поля.';
            errorDiv.style.display = 'block';
            return;
        }

        submitButton.setAttribute('aria-busy', 'true');
        submitButton.disabled = true;

        apiFetch('/api/employees/replacement', {
            method: 'POST',
            body: JSON.stringify(requestBody)
        })
        .then(result => {
            alert(`Успешно: ${result.message}`);
            document.getElementById('replacement-modal').close();
            form.reset();
        })
        .catch(error => {
            errorDiv.textContent = `Ошибка: ${error.message}`;
            errorDiv.style.display = 'block';
        })
        .finally(() => {
            submitButton.removeAttribute('aria-busy');
            submitButton.disabled = false;
        });
    }
    </script>
</body>
</html>